Требуется настроить ВМ1 так, чтобы она выполняла функцию пограничного маршрутизатора,
 где WAN - это интерфейс 1, а LAN - интерфейс 2.
Шлюз по умолчанию для ВМ2 это IP интерфейса 2 от ВМ1.
После успешной настройки с ВМ2 должен быть доступ в интернет.

*** Чтобы все сохранялось после перезагрузки ВМ надо менять соответствующие конфиги.

# На vm1:
Выдаём ip внутреннему соединению. Так, чтобы не слетело при перезагрузке вм.
```
ls /etc/netplan

```
На Ubuntu24 там будет 50-cloud-init.yaml
```
sudo nano /etc/netplan/50-cloud-init.yaml
```
В файлике правим до такого вида:
```
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s3:
      dhcp4: true      # интернет через DHCP (если интерфейс подключен к сети)
    enp0s8:
      dhcp4: false     # отключаем DHCP
      addresses:
        - 10.0.0.1/24  # устанавливаем вручную IP для локальной сети
```
Сохраняем изменения.

Применяем изменения:
`sudo netplan apply`

Проверяем, что все ок: `ip a`

Должно получиться что-то типа:
```
...
2: enp0s3: <...>
    inet 192.168.1.100/24
3: enp0s8: <...>
    inet 10.0.0.1/24
    ...
```

# На vm2 тоже выдаем ip и за одно добавляем шлюз по умолчанию:

```
sudo nano /etc/netplan/50-cloud-init.yaml
```
В файлике правим до такого вида:
```
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s3:
      dhcp4: true  
    enp0s8:
      dhcp4: false     # отключаем DHCP
      addresses:
        - 10.0.0.2/24  # назначаем IP
      gateway4: 10.0.0.1 # указываем шлюз по умолчанию
```
Сохраняем изменения.

Применяем изменения:
`sudo netplan apply`

Проверяем, что все ок: `ip a`

Должно получиться что-то типа:
```
...
2: enp0s3: <...>

3: enp0s8: <...>
    inet 10.0.0.2/24
    ...
```

# Настраиваем ВМ1 так, чтобы она работала как маршрутизатор
Настраиваем перенаправление трафика из локальной сети (10.0.0.0/24) в интернет.

## Настройка IP forwarding
В файлике /etc/sysctl.conf (в котором все закомментировано) надо раскомментировать строку `net.ipv4.ip_forward=1`. Если там =0 надо изменить на =1.

Сохраняем изменения.

Применяем изменения: `sudo sysctl -p`

Донастраиваем так, чтобы работало не только для вм1, но и для вм2. Нам нужно подменять локальный ip вм1 на публичный ip интерфейса вм1.

1. Проверим, что модуль iptable_nat загружен `lsmod | grep iptable_nat`.
Если вывод пустой, то установим: `sudo modprobe iptable_nat`
2. Настраиваем подмену ip: `sudo iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE`, где enp0s3 - интерфейс выходящий в интернет.
3. Проверяем, что все ок `sudo iptables -t nat -L POSTROUTING -v -n`. В таблице должна быть строчка с out = enp0s3.
4. Сохраняем изменения в конфиг, чтобы после перезагрузки вм все сохранилось. Для этого `sudo netfilter-persistent save`

# На всякий случай

Чтобы удалить строчку из iptables:
`sudo iptables -t nat -D [PREROUTING / POSTROUTING / INPUT / OUTPUT] <НОМЕР СТРОКИ ПРАВИЛА (НУМЕРАЦИЯ С 1)>`

Для проверки, что пакетики действительно убегают в интернет через вм1 `traceroute 8.8.8.8`. Тут первый ip должен быт ip вм1.

Если нет traceroute, можно его установить. Установится он только если настроена расшифровка доменных имен: `echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf`. Теперь можно делать и `ping google.com` и тд.

Если что-то не работает, можно попробовать отключить фаервол:
`sudo systemctl stop ufw`

Если ufw не установлено, то это ложь, надо установить и выключить его.