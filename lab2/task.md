Лабораторная работа 2

Цель: изучить настройку CI/CD в GitLab, получить практические навыки по развертыванию раннера и подключению его к репозиторию.

Задание:

Cоздать две ВМ (1 ядро, 2 Гб памяти на каждой будет достаточно). Настроить их в соответствии с заданием 1 из ЛР1. ВМ1 выполняет роль пограничного маршрутизатора, ВМ2 - является машиной в серой локальной сети.
На машине ВМ1 (пограничный маршрутизатор из ЛР1) открыть средствами сетевого экрана порт 22 для доступа только с ВМ2 и 80 для доступа из открытой сети.

На ВМ2 поднять shell-раннер и подключить его к репозиторию с проектом на кафедральном GitLab.
В качестве проекта можно использовать проект из курса “Основы разработки Web-приложений”, любой другой проект веб-приложения или предлагаемый в задании вариант с Nginx, раздающим статику.

В репозитории настроить CI/CD, состоящий из следующих стадий:
- build (сборка проекта)
- test (запуск тестов)
- deploy (развертывание собранного приложения на ВМ1)

Стадии build и test должны быть автоматическими, доступными для любой ветки. Стадия deploy – мануальной, доступной только для веток main/master и develop.

В результате прохождения пайплайна приложение должно быть доступно на ВМ1 на порту 80.

Для выполнения CI/CD пайплайна запрещено использовать пользователя root на ВМ1 и ВМ2!

При выборе проекта со статикой и веб-сервером Nginx в пайплайне требуется реализовать следующую логику:
1. На стадии build динамически формируются файлы со статикой. Обязательно при генерации статики использовать данные из коммита (например, хэш коммита или лежащий файлик в репозитории с какими-то данными и т.д.). В качестве статики предлагается генерация картинки/QR-кода любыми средствами (скрипты, утилиты) и вставка ее в html-страницу. Html-страница должна также содержать некоторый генерируемый на этапе билда из данных коммита текст (например, можно брать этот текст из файла в репозитории, который меняется через коммиты). На выходе формируется статика, состоящая из html-страницы и изображения на ней. Пример инструмента для генерации картинки: https://fixmypc.ru/post/vstavka-teksta-i-izobrazheniia-v-kartinku-s-python-pillow-pil/
2. На стадии тестов необходимо сделать проверку синтаксиса конфига Nginx соответствующими командами. Проверка делается на машине, где будет использоваться конфиг. Конфигурация веб-сервера должна храниться в gitlab-репозитории. Изменения конфигурации веб-сервера происходят через commit в gitlab.
3. На стадии деплоя разворачивается проект на ВМ1 и происходит актуализация конфига веб-сервера (Nginx). После деплоя на ВМ1 должны быть актуальный статический контент и веб-сервер, работающий с актуальным конфигом.